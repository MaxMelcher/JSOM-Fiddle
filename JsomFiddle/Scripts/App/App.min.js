var JsomFiddle; (function (e) { var t = function () { function e() { this.isDirty = false; this.template = ""; this.executingToast = null; this.saveDlg = null } e.prototype.init = function () { var e = this; var t = ace.require("ace/worker/worker_client"); t.WorkerClient = t.UIWorkerClient; $(window).bind("keydown", function (t) { if (t.ctrlKey || t.metaKey) { switch (String.fromCharCode(t.which).toLowerCase()) { case "s": t.preventDefault(); e.saveFiddle({ data: e }); break; case "r": t.preventDefault(); e.executeScript({ data: e }); break } } }); this.setupHtmlEditor(); this.setupJsEditor(); this.initSamples(); $("#results").load(function () { if (e.executingToast != null) e.executingToast.hide() }); $("#executeButton").click(e, e.executeScript); $("#saveButton").click(this, this.saveFiddle); $("#exportButton").click(this, this.exportScript); $("#importButton").click(this, this.importScript); $(".close-button").click(this, function (e) { $(this).parents(".ui-dialog-content").dialog("close") }); $(".naclose-button").click(this, function (e) { window.location.href = decodeURIComponent(e.data.getQueryStringParameter("SPHostUrl")) }); $("#backToSiteButton").click(this, function (e) { window.location.href = decodeURIComponent(e.data.getQueryStringParameter("SPHostUrl")) }); $(".import-button").click(this, function (e) { var t = e.data; t.executingToast = $.toast("Importing scripts", { type: "info", duration: 1e4 }); $.support.cors = true; var n = $("#importUrl").val(); var r = "https://script.google.com/macros/s/AKfycbxFZcqlPNgUIz97Q1FSX-5akze8X3Lx36iNqE_ltmBvfgWjH2c/exec?url="; n = r + encodeURIComponent(n) + "&_callback=?"; $.ajax({ url: n, crossDomain: true, error: function (e, t, n) { alert(t) }, complete: function (e) { }, success: function (e) { var n = e; var r = null; var i = SP.ClientContext.get_current(); if ($("#importType").val() == 0) r = i.get_web().get_lists().getByTitle("Samples"); else r = i.get_web().get_lists().getByTitle("Saved"); for (var s = 0; s < n.length; s++) { var o = n[s]; var u = r.addItem(null); u.set_item("Title", o.Title); u.set_item("JsomScript", o.JsomScript); u.set_item("JsomHtml", o.JsomHtml); u.update() } i.executeQueryAsync(function (e, n) { t.initSaved(); t.initSamples(); if (t.executingToast != null) t.executingToast.hide(); $.toast("Import has completed", { type: "success" }) }, function (e, t) { alert(t.get_message()) }) } }); $(this).parents(".ui-dialog-content").dialog("close") }); $("#helpButton").click(this, function (e) { $("#dialog-help").dialog("open") }); $("#dialog-noaccess").dialog({ resizable: false, height: 250, width: 520, autoOpen: false, modal: true }); $("#dialog-help").dialog({ resizable: false, height: 325, width: 560, autoOpen: false, modal: true }); $("#dialog-import").dialog({ resizable: true, height: 260, width: 450, autoOpen: false, modal: true }); this.saveDlg = $("#dialog-save").dialog({ resizable: true, height: 200, width: 300, autoOpen: false, modal: true }); var n = $("#results")[0]; var r = document.URL; n.contentWindow.location.href = "results.html" + r.substring(r.toLowerCase().indexOf("?")); var i = SP.ClientContext.get_current(); this.user = i.get_web().get_currentUser(); i.load(this.user); i.executeQueryAsync(function (e, t) { }) }; e.prototype.getQueryStringParameter = function (e) { var t = document.URL.split("?")[1].split("&"); var n = ""; for (var r = 0; r < t.length; r = r + 1) { var i = t[r].split("="); if (i[0] == e) return i[1] } }; e.prototype.setupTempFile = function () { var e = this; var t = SP.ClientContext.get_current(); var n = t.get_web(); var r = t.get_web().get_allProperties(); t.load(n); t.executeQueryAsync(function (i, s) { var o = n.getFolderByServerRelativeUrl(n.get_serverRelativeUrl() + "/pages/tempscripts"); var u = o.get_listItemAllFields(); t.load(u); t.executeQueryAsync(function () { var i = new SP.FileCreationInformation; $.get(n.get_serverRelativeUrl() + "/pages/tempscripts/results.html", function (n, s, a) { var f = new Date; i.set_url(f.getTime() + ".html"); i.set_content(new SP.Base64EncodedByteArray); var l = n; e.template = n; for (var c = 0; c < l.length; c++) { i.get_content().append(l.charCodeAt(c)) } var h = o.get_files().add(i); var p = r.get_fieldValues()["FiddleInitDone"]; alert(p); if (p != true) { u.breakRoleInheritance(true, true) } t.load(h); t.executeQueryAsync(function (t, n) { e.file = h; $("#executeButton").click(e, e.executeScript) }, function (e, t) { $("#dialog-noaccess").dialog("open") }) }) }, function (e, t) { alert(t.get_message()) }) }) }; e.prototype.exportScript = function (e) { var t = SP.ClientContext.get_current(); var n = t.get_web(); var r = n.get_lists().getByTitle("Exports"); var i = new SP.FileCreationInformation; var s = new Date; i.set_url(s.getTime() + ".txt"); i.set_content(new SP.Base64EncodedByteArray); var o = ace.edit("htmlEditor"); var u = ace.edit("jsEditor"); var a = { Title: "JSOM Fiddle Sample", JsomScript: u.getValue(), JsomHtml: o.getValue() }; var f = JSON.stringify(a); for (var l = 0; l < f.length; l++) { i.get_content().append(f.charCodeAt(l)) } var c = r.get_rootFolder().get_files().add(i); t.load(c); t.executeQueryAsync(function (e, t) { window.open(c.get_serverRelativeUrl(), "_blank") }, function (e, t) { alert(t.get_message()) }) }; e.prototype.importScript = function (e) { $("#dialog-import").dialog("open") }; e.prototype.initSamples = function () { var e = SP.ClientContext.get_current(); var t = new SP.CamlQuery; t.set_viewXml("<View><Query><Where><Gt><FieldRef Name='ID'/><Value Type='Counter'>0</Value></Gt></Where><OrderBy><FieldRef Name='Title'/></OrderBy></Query></View>"); this.samples = e.get_web().get_lists().getByTitle("Samples").getItems(t); e.load(this.samples); var n = this; e.executeQueryAsync(function (e, t) { var r = "<ul id='samplesList' class='myList'>"; for (var i = 0; i < n.samples.get_count() ; i++) { var s = n.samples.get_item(i); r += "<li value='" + i + "'>" + s.get_item("Title") + "</li>" } r += "</ul>"; $("#samplesList").replaceWith(r); $(document).on("click", "#samplesList li", function () { var e = ace.edit("htmlEditor"); var t = ace.edit("jsEditor"); if (n.isDirty == true) { if (confirm("Changes will be lost. Do you wish to continue?") == false) return } var r = parseInt($(this).attr("value")); if (r != -1) { var i = n.samples.get_item(r); var s = i.get_item("JsomHtml"); var o = i.get_item("JsomScript"); try { t.setValue(o); e.setValue(s); t.resize(); e.resize(); t.selection.clearSelection(); e.selection.clearSelection(); $("#samplesDialog").dialog("close"); $("#fiddleName").text("").hide(); n.currentFiddle = null; n.notDirty() } catch (u) { alert(u.message) } } }); n.initSaved() }, function (e, t) { alert(t.get_message()) }) }; e.prototype.notDirty = function () { this.isDirty = false }; e.prototype.initSaved = function () { var e = SP.ClientContext.get_current(); var t = e.get_web().get_lists().getByTitle("Saved").getItems(SP.CamlQuery.createAllItemsQuery()); e.load(t); var n = this; e.executeQueryAsync(function (e, r) { var i = "<ul id='savedList' class='myList'>"; for (var s = 0; s < t.get_count() ; s++) { var o = t.get_item(s); i += "<li value='" + s + "'>" + o.get_item("Title") + "</li>" } n.saved = t; i += "</ul>"; $("#savedList").replaceWith(i); $(document).on("click", "#savedList li", function () { var e = ace.edit("htmlEditor"); var t = ace.edit("jsEditor"); if (n.isDirty == true) { if (confirm("Changes will be lost. Do you wish to continue?") == false) return } var r = parseInt($(this).attr("value")); if (r != -1) { var i = n.saved.get_item(r); var s = i.get_item("JsomHtml"); var o = i.get_item("JsomScript"); t.setValue(o); e.setValue(s); t.selection.clearSelection(); e.selection.clearSelection(); t.resize(); e.resize(); $("#fiddleName").text(i.get_item("Title")).show(); n.currentFiddle = i; n.notDirty() } }) }, function (e, t) { alert(t.get_message()) }) }; e.prototype.setupHtmlEditor = function () { var e = this; var t = ace.edit("htmlEditor"); t.setTheme("ace/theme/chrome"); t.getSession().setMode("ace/mode/html"); t.resize(); t.getSession().on("change", function () { var t = $("#fiddleName").text(); e.isDirty = true; if (t.indexOf("*") == -1) { if (t == "" || t == null) t = "untitled"; $("#fiddleName").text(t + "*").show() } }) }; e.prototype.setupJsEditor = function () { var e = this; var t = ace.edit("jsEditor"); t.setTheme("ace/theme/twilight"); t.getSession().setMode("ace/mode/javascript"); t.resize(); t.getSession().on("change", function () { var t = $("#fiddleName").text(); e.isDirty = true; if (t.indexOf("*") == -1) { if (t == "" || t == null) t = "untitled"; $("#fiddleName").text(t + "*").show() } }) }; e.prototype.saveFiddle = function (e) { var t = e.data; if (t.currentFiddle == null) { $("#dialog-save").dialog("open"); $(".save-button").click(function (e) { var n = this; t.doSave($("#saveTitle").val(), function (e) { $(".save-button").unbind("click"); t.saveDlg.dialog("close") }) }) } else t.doSave(t.currentFiddle.get_item("Title"), function (e) { $(this).parents(".ui-dialog-content").dialog("close") }) }; e.prototype.doSave = function (e, t) { try { var n = this; if (e == null || e == "") { alert("Please enter a valid title"); return } var r = ace.edit("jsEditor"); var i = ace.edit("htmlEditor"); if (e.indexOf("*") > -1) e = e.substr(0, e.length - 1); var s = SP.ClientContext.get_current(); var o = s.get_web().get_lists().getByTitle("Saved"); var u = new SP.CamlQuery; u.set_viewXml("<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>" + e + "</Value></Eq></Where></Query></View>"); var a = o.getItems(u); s.load(a); s.executeQueryAsync(function (u, f) { if (n.currentFiddle == null && a.get_count() > 0) { alert("An item named '" + e + "' already exists. Please choose a different name."); return } if (n.currentFiddle == null) { n.currentFiddle = o.addItem(null); n.currentFiddle.set_item("Title", e) } n.currentFiddle.set_item("JsomScript", r.getValue()); n.currentFiddle.set_item("JsomHtml", i.getValue()); n.currentFiddle.set_item("JsomUser", n.user.get_id()); n.currentFiddle.update(); s.load(n.currentFiddle); s.executeQueryAsync(function (r, i) { $("#fiddleName").text(e).show(); n.isDirty = false; t(null); $.toast("Fiddle " + e + "' has been saved", { type: "success" }); n.initSaved() }, function (e, n) { alert(n.get_message()); t(n) }) }, function (e, n) { alert(n.get_message()); t(n) }) } catch (f) { alert(f) } }; e.prototype.executeScript = function (e) { var t = e.data; var n = $("#results")[0]; var r = ace.edit("jsEditor"); var i = ace.edit("htmlEditor"); n.contentWindow.document.body.innerHTML = i.getValue(); var s = n.contentWindow.document.createElement("script"); $(s).text(r.getValue()); n.contentWindow.document.body.appendChild(s) }; return e }(); e.App = t; $(document).ready(function () { SP.SOD.executeFunc("sp.js", "SP.ClientContext", function () { SP.SOD.executeFunc("sp.ui.dialog.js", "SP.UI.ModelDialog", null) }); var t; t = new e.App; t.init() }) })(JsomFiddle || (JsomFiddle = {}))